syntax = "proto3";

package importpb;

import "metapb.proto";
import "kvrpcpb.proto";
import "errorpb.proto";
import "gogoproto/gogo.proto";

option (gogoproto.sizer_all) = true;
option (gogoproto.marshaler_all) = true;
option (gogoproto.unmarshaler_all) = true;

option java_package = "com.pingcap.tikv.kvproto";

service Import {
    rpc Write(stream WriteRequest) returns (WriteResponse) {}
    rpc Flush(FlushRequest) returns (FlushResponse) {}

    rpc IngestSST(IngestSSTRequest) returns (IngestSSTResponse) {}
    rpc UploadSST(stream UploadSSTRequest) returns (UploadSSTResponse) {}
}

message Mutation {
  enum OP {
    Put = 0;
  }
  OP op = 1;
  bytes key = 2;
  bytes value = 3;
}

message WriteRequest {
  message Meta {
    bytes uuid = 1;
    uint64 commit_ts = 2;
  }
  Meta meta = 1;
  repeated Mutation mutations = 2;
}

message WriteResponse {
}

message FlushRequest {
  bytes uuid = 1;
}

message FlushResponse {
}

message SSTMeta {
    // The size of the file.
    uint64 len = 1;
    // The CRC32 checksum of the file.
    uint32 crc32 = 2;
    // The handle which identifies the file.
    SSTHandle handle = 3;
}

message SSTHandle {
    // The UUID of the file, to distinguish files with the same data.
    bytes uuid = 1;
    // The CF that this file will be ingested to.
    string cf_name = 2;
    // The region that this file will be ingested to.
    uint64 region_id = 3;
    // The epoch of the region when this file is uploaded.
    metapb.RegionEpoch region_epoch = 4;
}

message IngestSSTRequest {
    kvrpcpb.Context context = 1;
    // The handles of the files that will be ingested.
    // Only files of the same column family can be ingested atomically for now.
    repeated SSTHandle handles = 2;
}

message IngestSSTResponse {
    errorpb.Error error = 1;
}

message UploadSSTRequest {
    SSTMeta meta = 1;
    bytes   data = 2;
}

message UploadSSTResponse {
}
